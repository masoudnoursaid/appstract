# Payment.Hub.Sdk  [![.NET](https://img.shields.io/badge/--512BD4?logo=.net&logoColor=ffffff)](https://dotnet.microsoft.com/)

![version](https://img.shields.io/badge/version-1.0.0-blue)

# Introduction

The payment hub offers a variety of payment providers,
including options like [PayPal](https://paypal.com), [Stripe](https://Stripe.com)
, and [Billplz](https://Billplz.com),
which is exclusively available in Malaysia. There is a single endpoint
for all providers, and it requires a specific input format.
By simply calling this endpoint
, we can handle all your payment needs. Enjoy the convenience!

# Installation

> nuget install payment.hub.sdk -Source "GitLab"

> nuget source Add -Name "GitLab"
> -Source "https://gitlab-registry.maxtld.com/api/v4/projects/25/packages/nuget/index.json" -UserName <your_username>
> -Password <your_token>

# Get Started

```csharp
builder.Services.ConfigurePayHubClient(cnf =>
{
    // Set payment microservice domain
    cnf.ConnectionConfiguration.Address = "payment.azihub.com";
    cnf.ConnectionConfiguration.Timeout = 100;
    // your webhook address
    cnf.ConnectionConfiguration.WebHook = "http://localhost:7107/hook";

    // Security method between company applications and payment hub
    cnf.SecurityConfiguration.Method = SecurityMethod.HMAC;

    // Your application api secret
    cnf.SecurityConfiguration.ApiSecret = "MY_API_SECRET";

    // Your application api key
    cnf.SecurityConfiguration.ApiKey = "MY_API_KEY";
});

```

> **Warning:** We highly recommend placing your ApiSecret and ApiKey in your .env file.
> For additional information, please refer to [this link](https://en.wikipedia.org/wiki/Environment_variable)



After configuring your service, let's proceed to set up the PayHub middleware:

```csharp
// protect your web hook url(s), which seted up at ConfigurePayHubClient
app.UsePayHubCallBackAuthentication();
```

Congratulations! You have successfully set up everything you need for the payment
process.
Now, you should inject the IPayHubClient into your class or handler. With this,
you can generate a valid payment url for your users to proceed with the payment process:

```csharp
public class MyClassOrHandler
{
   private readonly IPayHubClient _payHubClient;

    public MyClassOrHandler(IPayHubClient payHubClient)
    {
        _payHubClient = payHubClient;
    }

    public async Task<object> Get()
    {
        /*
         * Here, you should initially retrieve all available methods in the hub.
         * With this information, you can establish a connection to the hub and make a payment using a specific payment method.
         */
        var methods = await _payHubClient.GetPaymentMethodList();
        var payPal = methods.Data!.Dtos.Single(m => m.GetWay == SourceImplementedGetWay.Paypal);
        var billplz = methods.Data!.Dtos.Single(m => m.GetWay == SourceImplementedGetWay.Billplz);
        var stripe = methods.Data!.Dtos.Single(m => m.GetWay == SourceImplementedGetWay.Stripe);

        /*
         * All fields are required, so please fill them out carefully.
         * Please ensure that the sum of item prices equals the "Amount" property.
         */
        var payload = new CreatePaymentPayload()
        {
            Items = new List<PaymentItem>()
            {
                new()
                {
                    Currency = "USD",
                    Description = "This is just a mock item - 1",
                    Name = "Item number 1",
                    Price = "1500",
                    Quantity = 1,
                    Sku = $"ITEM-1_{Guid.NewGuid()}"
                },
                new()
                {
                    Currency = "USD",
                    Description = "This is just a mock item - 2",
                    Name = "Item number 2",
                    Price = "500",
                    Quantity = 1,
                    Sku = $"ITEM-2_{Guid.NewGuid()}"
                }
            },
            Amount = 2000,
            Currency = "USD",
            Description = "Description from paypal integration test",
            Email = $"customer.email.{Guid.NewGuid()}@email.com",
            Name = $"customer.name.{Guid.NewGuid()}",
            Mobile = "+447404788642",
            InvoiceNumber = $"INVOICE-NUMBER_{Guid.NewGuid()}",

            //this should be your end point
            ClientRedirectUrl = "https://example.com/pay"
        };

        var pay = await _payHubClient.Pay(payload, payPal.Id /*or any other method id*/);

        // Here is pay url, you should redirect user to this url
        var payUrl = pay.Data!.PaymentUrl;

        // Here is payment id which generated by pay hub
        var paymentId = pay.Data!.PaymentId;

        // Here provided id which generated by payment method provider
        var providedId = pay.Data!.ProvidedId;

        return pay;
    }
}
```

> **Information:** We highly recommend generating a unique ID for your user invoice and then sending this ID via
> InvoiceId.
> You can find information on generating a unique id for your
> client [here](https://en.wikipedia.org/wiki/Universally_unique_identifier).


After obtaining the payment URL from your chosen provider,
you should redirect the user to the payment gateway. Following the purchase
, we will then send the user to your specified ``ClientRedirectUrl``.

# After Payment

Here we will call your webhook and notify you about payment result.

```csharp
[HttpPost]
[Route("/hook")]
public IActionResult HookAction(WebHookNotifyDto dto)
{
    // with payment id you can query to our database and get anything you need according to the payment
    var paymentId = dto.PaymentId;
    
    // generated by the provider(like paypal or stripe)
    var providedId = dto.ProvidedId;
    
    // with invoice number you can check which payment is verifying or rejecting
    var invoiceNumber = dto.InvoiceNumber;
    
    // just for make sure the total amount which decreased from user bank account is same with what you expected
    var amount = dto.Amount;
    
    // status & is_successful
    var status = dto.Status;
    var isSuccessful = dto.Successful;
    
    return Ok(dto);
}
```

The connection between your system and the payment hub is protected
by [HMAC Authentication](https://en.wikipedia.org/wiki/HMAC), which is customized for each company's
application or any registered application within the cluster.

By including ``app.UsePayHubCallBackAuthentication();`` in your app builder,
the PayHub middleware will automatically authenticate any request to your webhook using
[HMAC Authentication](https://en.wikipedia.org/wiki/HMAC),
based on the configuration you set with
``opt.SecurityConfiguration.Method = SecurityMethod.HMAC;``



